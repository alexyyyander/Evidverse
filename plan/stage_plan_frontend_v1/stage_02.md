# Stage 02: 点子→剧本→人物/视频生成链路接入

## 目标
在 Editor 内完成“用户点子 → 剧本/分镜 → 人物设定 → 图像/视频生成 → 自动回填到时间轴”的闭环，并做到可重试、可追踪、可编辑。

## 背景与痛点
- “生成”是异步且不稳定的链路：需要任务队列、状态、失败原因与重试策略，否则用户只会看到卡死或空白。
- 剧本/人物/片段之间需要稳定引用关系，才能在生成完成后正确回填到 timeline 并继续编辑。
- 用户生成的结果必须可编辑（prompt 可改、参数可调、替换重生成）。

## 交付物
- 点子输入 → 生成剧本（结构化 scenes/beats）→ 人物列表/角色卡 → 图像/视频生成任务队列 → 生成结果自动挂载到对应 Beat 与 Timeline。
- 每个生成结果都能追溯来源：来自哪个点子/哪个 Beat/哪个人物/什么参数。
- 生成失败可诊断、可重试、可替换（不会“生成完就丢了”）。

## Todo List
- [x] 点子输入面板：支持一句话点子 + 高级参数（风格、比例、时长、镜头数、节奏、语言、分辨率）。
- [x] 点子版本化：每次生成记录为 `IdeaVersion`，可回退与对比（避免用户改了点子后找不到旧版本）。
- [ ] 剧本生成输出契约：定义固定 JSON schema（Scene/Beat 字段完整、可校验），并在前端做 schema 校验与错误提示。
- [x] 剧本编辑器：Beat 可编辑（文案/镜头描述/时长）。
- [x] 重新生成某个 Beat：支持一键对单个 Beat 发起重生成并回填（替换/并存）。
- [x] 人物提取：从剧本提取人物候选列表，并支持重命名。
- [x] 人物合并/删除：解决同名不同人、同人不同名问题。
- [x] 角色卡编辑：外观描述、服装、关键词、禁用词、参考图列表、生成风格参数。
- [x] 角色图像生成任务：按人物生成参考图（基础版：生成 1 张并设置为头像）。
- [x] Beat→镜头拆分（可选）：将 Beat 进一步拆为 shots（镜头），为后续更精细的时间轴对齐做准备。
- [x] 视频生成任务：按点子生成 clip（工作流：脚本 + 图 + 视频）。
- [x] 生成任务模型：统一 Task（type/status/progress/error/result/refIds），所有生成都走同一个队列与展示面板。
- [x] 生成队列 UI：列表 + 状态 + 重试（基础版）。
- [x] 失败与重试策略：失败原因展示 + 一键重试（基础版：沿用参数）。
- [x] 自动回填策略：生成成功后创建 TimelineItem 并绑定到对应 Beat（基础版：追加）。
- [x] 自动对齐策略：根据 Beat 建议时长设置 clip 时长，并自动选中该片段（基础版）。
- [x] 手动覆盖策略：用户拖拽改了对齐后，系统不再强制覆盖（除非用户明确点击“重新对齐”）。

## 验收标准
- 用户可以从一个点子出发，在同一页面看到“剧本 → 人物 → 生成任务 → 时间轴片段”的完整链路。
- 任意生成任务可追踪、可重试，成功结果会可靠地落到对应剧情段落与时间轴片段上。
- 用户点击某个片段时，能看到它的生成参数/关联人物/对应剧本段落，并支持基于此片段继续迭代生成。
- 用户可以只重做“一个 Beat 或一个人物”的生成，不必推翻整个项目。
